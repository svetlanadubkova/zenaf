<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zen as fuck | transcendent experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            font-family: 'Space Mono', monospace;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            cursor: none;
        }

        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.8;
        }

        #video-hero {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
            opacity: 1;
            transition: opacity 0.5s ease;
            width: 80%;
            max-width: 800px;
        }

        h1 {
            font-size: clamp(3rem, 10vw, 8rem);
            line-height: 1;
            margin-bottom: 1rem;
            text-transform: lowercase;
        }

        h2 {
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            margin-bottom: 1rem;
        }

        p {
            font-size: clamp(1rem, 2vw, 1.5rem);
            margin-bottom: 1rem;
        }

        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            background-color: transparent;
            color: #fff;
            border: 2px solid #fff;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-top: 1rem;
        }

        .btn:hover {
            background-color: #fff;
            color: #000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .meditation-content {
            background-color: rgba(17, 17, 17, 0.6);
            padding: 1.5rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        #visualizer {
            width: 100%;
            height: 60px;
            background-color: rgba(34, 34, 34, 0.6);
            margin-bottom: 15px;
            border-radius: 5px;
        }

        #meditationText {
            font-size: 1rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        #transcriptionText {
            font-size: 0.9rem;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(34, 34, 34, 0.6);
            border-radius: 5px;
            max-height: 100px;
            overflow-y: auto;
        }

        #questionContainer {
            margin-bottom: 15px;
        }

        #questionContainer input,
        #questionContainer select,
        #questionContainer textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background-color: rgba(34, 34, 34, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-family: 'Space Mono', monospace;
            transition: all 0.3s ease;
            border-radius: 5px;
        }

        #questionContainer input:focus,
        #questionContainer select:focus,
        #questionContainer textarea:focus {
            outline: none;
            border-color: #ffc5e1;
            box-shadow: 0 0 10px rgba(255, 179, 231, 0.929);
        }

        .custom-cursor {
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: difference;
            transition: transform 0.1s ease;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .disclaimer {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .meditation-content {
                width: 95%;
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <div id="scene-container"></div>
    <div id="video-container">
        <video autoplay muted loop id="video-hero">
            <source src="https://storage.googleapis.com/trylame/forbg.jpg%20(1)%20-%20Frame%20Interpolation%20(2)_rhea1.mp4" type="video/mp4">
        </video>
    </div>
    <div class="custom-cursor"></div>

    <div id="hero" class="content">
        <h1>zen as fuck</h1>
        <p>mindfulness for the modern mess</p>
        <a href="#" class="btn" id="startMeditationBtn">get zen now</a>
        <p class="disclaimer">disclaimer: if you're offended by colorful language, this might not be your cosmic cup of fucking tea.</p>
    </div>

    <div id="meditationOverlay" class="overlay" style="display: none;">
        <div class="meditation-content">
            <button class="close-btn">&times;</button>
            <h2>let's get you zen af with a custom, guided meditation</h2>
            <div id="questionContainer"></div>
            <div id="meditationContainer" style="display: none;">
                <canvas id="visualizer"></canvas>
                <div id="meditationText"></div>
                <div id="transcriptionText"></div>
                <button id="endMeditation" class="btn">end meditation</button>
            </div>
            <div class="loading">
                <p id="loadingMessage"></p>
                <span class="loading-dots"></span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM fully loaded and parsed');
            initializeDOMElements();
            setupEventListeners();
            initializeQuestions();
            initThreeJS();
        });

        function initializeDOMElements() {
            window.startButton = document.getElementById('startMeditationBtn');
            window.meditationOverlay = document.getElementById('meditationOverlay');
            window.questionContainer = document.getElementById('questionContainer');
            window.meditationContainer = document.getElementById('meditationContainer');
            window.meditationText = document.getElementById('meditationText');
            window.transcriptionText = document.getElementById('transcriptionText');
            window.endMeditationButton = document.getElementById('endMeditation');
            window.loadingElement = document.querySelector('.loading');
            window.loadingMessage = document.getElementById('loadingMessage');
            window.closeButton = document.querySelector('.close-btn');
            window.visualizer = document.getElementById('visualizer');
        }

        function setupEventListeners() {
            if (window.startButton) {
                window.startButton.addEventListener('click', startMeditation);
            }
            if (window.endMeditationButton) {
                window.endMeditationButton.addEventListener('click', endMeditation);
            }
            if (window.closeButton) {
                window.closeButton.addEventListener('click', closeMeditationOverlay);
            }
            setupCustomCursor();
        }

        function setupCustomCursor() {
            const cursor = document.querySelector('.custom-cursor');
            document.addEventListener('mousemove', (e) => {
                cursor.style.left = `${e.clientX}px`;
                cursor.style.top = `${e.clientY}px`;
            });
        }

        function initializeQuestions() {
            window.questions = [
                { id: 'name', text: "What's your name?", type: 'text' },
                { id: 'stress', text: "On a scale of 1-10, how overwhelmed are you right now?", type: 'number', min: 1, max: 10 },
                { id: 'stressType', text: "Is this stress related to work, relationships, or something else?", type: 'select', options: ['Work', 'Relationships', 'Other'] },
                { id: 'situation', text: "What are you currently stressed about? Describe the situation in full and include names and be as specific as possible.", type: 'textarea' },
                { id: 'physical', text: "How are you feeling physically right now?", type: 'text' },
                { id: 'tension', text: "Where do you feel the most tension in your body?", type: 'text' },
                { id: 'time', text: "How much time do you have to calm the fuck down right now?", type: 'select', options: ['5 min', '10 min', '20 min'] }
            ];
            window.currentQuestionIndex = 0;
            window.userResponses = {};
        }

        function startMeditation(event) {
            event.preventDefault();
            window.meditationOverlay.style.display = 'flex';
            showNextQuestion();
        }

        function showNextQuestion() {
            if (window.currentQuestionIndex < window.questions.length) {
                const question = window.questions[window.currentQuestionIndex];
                let inputHTML = generateInputHTML(question);

                window.questionContainer.innerHTML = `
                    <h3>${question.text}</h3>
                    ${inputHTML}
                    <button onclick="submitAnswer()" class="btn">Next</button>
                `;

                const input = document.getElementById(question.id);
                if (input) {
                    input.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            submitAnswer();
                        }
                    });
                }
            } else {
                startGuidedMeditation();
            }
        }

        function generateInputHTML(question) {
            switch (question.type) {
                case 'text':
                case 'number':
                    return `<input type="${question.type}" id="${question.id}" ${question.min ? `min="${question.min}"` : ''} ${question.max ? `max="${question.max}"` : ''}>`;
                case 'select':
                    return `<select id="${question.id}">
                        ${question.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>`;
                case 'textarea':
                    return `<textarea id="${question.id}"></textarea>`;
                default:
                    return '';
            }
        }

        function submitAnswer() {
            const question = window.questions[window.currentQuestionIndex];
            const answer = document.getElementById(question.id).value;
            window.userResponses[question.id] = answer;
            window.currentQuestionIndex++;
            showNextQuestion();
        }

        let socket;
        let audioContext;
        let analyser;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 3;

        function startGuidedMeditation() {
            window.questionContainer.style.display = 'none';
            window.loadingElement.style.display = 'block';
            cycleLoadingMessages();

            connectWebSocket();
        }

        function connectWebSocket() {
            console.log("Connecting to WebSocket server...");
            socket = new WebSocket('wss://zenafaiguidedmeditation.onrender.com');
            
            socket.onopen = function(event) {
                console.log('Connected to server');
                reconnectAttempts = 0;
                socket.send(JSON.stringify({
                    type: "message.create",
                    message: {
                        content: `Based on the following user responses, provide a personalized guided meditation in the Zen as Fuck style: ${JSON.stringify(window.userResponses)}`,
                        role: "user"
                    }
                }));
            };
            
            socket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                if (message.type === 'meditation_text') {
                    window.loadingElement.style.display = 'none';
                    window.meditationContainer.style.display = 'block';
                    typeOutText(message.content);
                } else if (message.type === 'meditation_audio') {
                    playAudioAndVisualize(message.content);
                }
            };

            socket.onclose = function(event) {
                console.log('Disconnected from server');
                if (reconnectAttempts < maxReconnectAttempts) {
                    console.log(`Attempting to reconnect... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 3000); // Wait 3 seconds before trying to reconnect
                } else {
                    handleConnectionFailure();
                }
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                // The onclose handler will be called after this, so we'll handle reconnection there
            };
        }

        function handleConnectionFailure() {
            window.loadingElement.style.display = 'none';
            window.meditationContainer.style.display = 'block';
            window.meditationText.innerHTML = `
                <p>We're having trouble connecting to our zen servers right now. But don't let that stress you out!</p>
                <p>Here's a quick meditation you can try:</p>
                <ol>
                    <li>Take a deep breath in for 4 seconds.</li>
                    <li>Hold it for 4 seconds.</li>
                    <li>Exhale slowly for 6 seconds.</li>
                    <li>Repeat this 5 times, focusing on your breath.</li>
                </ol>
                <p>Remember, you're doing great just by taking a moment for yourself.</p>
                <button onclick="retryConnection()" class="btn">Try Again</button>
            `;
        }

        function retryConnection() {
            window.meditationText.innerHTML = '';
            window.loadingElement.style.display = 'block';
            reconnectAttempts = 0;
            connectWebSocket();
        }

        function cycleLoadingMessages() {
            const messages = [
                "Preparing your zen...",
                "give it a sec. chill is coming.",
                "breathe. loading your peace.",
                "almost zen time..."
            ];
            let index = 0;
            window.loadingMessage.textContent = messages[index];
            setInterval(() => {
                index = (index + 1) % messages.length;
                window.loadingMessage.textContent = messages[index];
            }, 3000);
        }

        function typeOutText(text) {
            const words = text.split(' ');
            let i = 0;
            const intervalId = setInterval(() => {
                if (i < words.length) {
                    window.meditationText.innerHTML += words[i] + ' ';
                    i++;
                } else {
                    clearInterval(intervalId);
                }
            }, 200);
        }

        function playAudioAndVisualize(audioData) {
            const audio = new Audio(`data:audio/wav;base64,${audioData}`);
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
            }

            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            const canvas = window.visualizer;
            const canvasCtx = canvas.getContext('2d');

            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                const WIDTH = canvas.width;
                const HEIGHT = canvas.height;

                requestAnimationFrame(draw);

                analyser.getByteFrequencyData(dataArray);

                canvasCtx.fillStyle = 'rgb(0, 0, 0)';
                canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

                const barWidth = (WIDTH / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2;

                    canvasCtx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                    canvasCtx.fillRect(x, HEIGHT - barHeight / 2, barWidth, barHeight);

                    x += barWidth + 1;
                }
            }

            draw();
            audio.play();

            // Speech recognition for transcription
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    window.transcriptionText.innerHTML = finalTranscript + '<i style="color: #999;">' + interimTranscript + '</i>';
                };

                recognition.start();

                audio.onended = function() {
                    recognition.stop();
                };
            }
        }

        function endMeditation() {
            if (socket) {
                socket.close();
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                analyser = null;
            }
            closeMeditationOverlay();
        }

        function closeMeditationOverlay() {
            window.meditationOverlay.style.display = 'none';
            window.meditationText.textContent = '';
            window.transcriptionText.textContent = '';
            window.questionContainer.style.display = 'block';
            window.meditationContainer.style.display = 'none';
            window.loadingElement.style.display = 'none';
            window.currentQuestionIndex = 0;
            window.userResponses = {};
            const canvas = window.visualizer;
            const canvasCtx = canvas.getContext('2d');
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function initThreeJS() {
            let scene, camera, renderer, particles;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('scene-container').appendChild(renderer.domElement);

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 5000; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(2000));
                vertices.push(THREE.MathUtils.randFloatSpread(2000));
                vertices.push(THREE.MathUtils.randFloatSpread(2000));
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0xffffff, size: 3 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            camera.position.z = 500;

            function animate() {
                requestAnimationFrame(animate);
                particles.rotation.x += 0.0001;
                particles.rotation.y += 0.0001;
                renderer.render(scene, camera);
            }

            animate();

            window.addEventListener('resize', onWindowResize, false);

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        // Make submitAnswer global so it can be called from HTML
        window.submitAnswer = submitAnswer;
    </script>
</body>
</html>